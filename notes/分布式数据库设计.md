### 最简单的数据库

``` bash
#!/bin/bash

db_set （）{
    echo "$1,$2" >> database.txt
}

db_get （）{
    grep "~$1" database.txt | sed "s/~$1,//" | tail -n 1
}   

echo "test"
db_set "test" "test"
db_get "test"

echo "test json value"
db_set "test json value" "{\"name\":\"test\",\"age\":18}"
db_get "test json value"

cat database.txt
```

考虑复杂的问题：
- 并发控制
- 回收磁盘空间
- 控制日志文件大小
- 处理错误
- 部分完成写记录

问题：
- 日志保存了大量的记录，`db_get`的性能非常差, 每次查找，都需要从头到尾扫描整个数据库文件找到key的位置。开销是O(n).

所以，为了高效的查找Key, 需要引入索引。
- 写入，除了追加，还要更新索引。所以索引会降低写入的效率。所以通常不会对所有内容进行索引。

#### 哈希索引

追加日志的时候把每条记录的偏移和记录做一个HashMap, 这样读取的时候就可以直接定位到要查找的数据。

所以读取的时候非常快，时间复杂度O(1)。读取的流程是，到最新段搜索key, 找不到则到次新段

写入的时候就需要同时更新HashMap

还需要考虑内存容量和磁盘容量

磁盘容量的管理非常类似GC的内存管理：压缩段，合并段（单独的后台线程处理）

如何压缩段？只保留最新的key的value，每个key唯一

如何合并段，为何要合并？因为压缩之后段空间有剩余

适用的场景，Key比较少，Value更新非常频繁的情况

如何恢复哈希索引？

- 启动的时候重新扫描文件
- 哈希表做一个快照（这点不是很理解，需要查一下资料）

如何删除一条记录？

如何区间查找？（Top N）

是否必须使用密集索引？

什么是SSTasble？

如何实现SSTable?(AVLtree)

#### BTree要点

- 按页读取
- 从root节点所在页开始索引
- 每个节点有其它页的索引
- 插入节点超出固定空间需要折半





